<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>WebAuthn Demo</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
    }
    button {
      padding: 10px 15px;
      background-color: #4285f4;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 10px 0;
    }
    button:hover {
      background-color: #3367d6;
    }
    .card {
      border: 1px solid #ddd;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .message {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
    }
    .error {
      background-color: #f8d7da;
      color: #721c24;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
    }
    .hidden {
      display: none;
    }
    .environment-warning {
      background-color: #fff3cd;
      border: 1px solid #ffeeba;
      color: #856404;
      padding: 10px;
      margin-bottom: 20px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <h1>WebAuthn Demo</h1>
  
  <div id="environmentWarning" class="environment-warning">
    ATENCIÓN: Estás ejecutando esta app en un entorno local. WebAuthn requiere HTTPS o localhost.
    <br>
    Para pruebas reales, debes desplegar este archivo HTML en tu dominio <strong>mendozavegajeffersonjoe.workers.dev</strong>
  </div>

  <div class="card">
    <h2>Prueba Simple de WebAuthn</h2>
    <button id="testWebAuthn">Probar compatibilidad WebAuthn</button>
    <div id="testMessage" class="message hidden"></div>
  </div>
  
  <div class="card">
    <h2>Registro</h2>
    <div>
      <label for="username">Nombre de usuario:</label>
      <input type="text" id="username" placeholder="Introduce un nombre de usuario">
    </div>
    <div>
      <label for="displayname">Nombre para mostrar:</label>
      <input type="text" id="displayname" placeholder="Introduce tu nombre completo">
    </div>
    <button id="registerBtn">Registrarse con WebAuthn</button>
    <div id="registerMessage" class="message hidden"></div>
  </div>

  <div class="card">
    <h2>Iniciar Sesión</h2>
    <div>
      <label for="loginUsername">Nombre de usuario:</label>
      <input type="text" id="loginUsername" placeholder="Introduce tu nombre de usuario">
    </div>
    <button id="loginBtn">Iniciar Sesión con WebAuthn</button>
    <div id="loginMessage" class="message hidden"></div>
  </div>

  <div id="userPanel" class="card hidden">
    <h2>Bienvenido <span id="welcomeUser"></span></h2>
    <p>Has iniciado sesión correctamente mediante WebAuthn.</p>
    <button id="logoutBtn">Cerrar Sesión</button>
  </div>

  <script>
    // Detectar entorno (local o producción)
    const isLocalhost = window.location.hostname === "localhost" || 
                        window.location.hostname === "127.0.0.1" ||
                        window.location.hostname === "";
    
    // URLs del servidor
    const SERVER_URL = "https://servidor.mendozavegajeffersonjoe.workers.dev";
    
    // Referencias a elementos DOM
    const usernameInput = document.getElementById('username');
    const displaynameInput = document.getElementById('displayname');
    const loginUsernameInput = document.getElementById('loginUsername');
    const registerBtn = document.getElementById('registerBtn');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const registerMessage = document.getElementById('registerMessage');
    const loginMessage = document.getElementById('loginMessage');
    const userPanel = document.getElementById('userPanel');
    const welcomeUser = document.getElementById('welcomeUser');
    const testButton = document.getElementById('testWebAuthn');
    const testMessage = document.getElementById('testMessage');
    const environmentWarning = document.getElementById('environmentWarning');
    
    // Mostrar/ocultar advertencia según entorno
    if (!isLocalhost) {
      environmentWarning.classList.add('hidden');
    }

    // Comprobar si el navegador soporta WebAuthn
    if (!window.PublicKeyCredential) {
      showMessage(registerMessage, 'Tu navegador no soporta WebAuthn. Por favor, usa un navegador más reciente.', 'error');
      registerBtn.disabled = true;
      loginBtn.disabled = true;
      testButton.disabled = true;
    }

    // Funciones de utilidad
    function showMessage(element, message, type) {
      element.textContent = message;
      element.className = `message ${type}`;
      element.classList.remove('hidden');
    }

    function hideMessage(element) {
      element.classList.add('hidden');
    }

    // Conversiones entre ArrayBuffer y Base64
    function arrayBufferToBase64(buffer) {
      const bytes = new Uint8Array(buffer);
      let binary = '';
      for (let i = 0; i < bytes.byteLength; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      return btoa(binary)
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=/g, '');
    }

    function base64ToArrayBuffer(base64) {
      const binary = atob(base64.replace(/-/g, '+').replace(/_/g, '/'));
      const bytes = new Uint8Array(binary.length);
      for (let i = 0; i < binary.length; i++) {
        bytes[i] = binary.charCodeAt(i);
      }
      return bytes.buffer;
    }

    // Test simple de WebAuthn (funciona en localhost)
    async function testWebAuthnCompat() {
      try {
        // Intentar crear una credencial simple con un RP ID que es válido para localhost
        const challengeBuffer = new Uint8Array(32);
        window.crypto.getRandomValues(challengeBuffer);
        
        const userIdBuffer = new Uint8Array(16);
        window.crypto.getRandomValues(userIdBuffer);
        
        const publicKeyOptions = {
          challenge: challengeBuffer.buffer,
          rp: {
            // Importante: para localhost, usamos 'localhost' como rpId
            name: "WebAuthn Test",
            id: isLocalhost ? "localhost" : window.location.hostname
          },
          user: {
            id: userIdBuffer.buffer,
            name: "test-user@example.com",
            displayName: "Test User"
          },
          pubKeyCredParams: [
            { type: "public-key", alg: -7 } // ES256
          ],
          timeout: 30000,
          attestation: "none",
          authenticatorSelection: {
            authenticatorAttachment: "platform",
            userVerification: "discouraged"
          }
        };
        
        // Solo probamos que podemos crear una credencial
        await navigator.credentials.create({ publicKey: publicKeyOptions });
        
        showMessage(testMessage, "¡WebAuthn funciona correctamente en este dispositivo! Puedes usar WebAuthn para autenticación.", 'success');
      } catch (error) {
        console.error("Error en prueba de WebAuthn:", error);
        showMessage(testMessage, `Error en WebAuthn: ${error.message}`, 'error');
      }
    }

    // Registro WebAuthn
    async function registerWebAuthn() {
      const username = usernameInput.value.trim();
      const displayName = displaynameInput.value.trim();
      
      if (!username || !displayName) {
        showMessage(registerMessage, 'Por favor, completa todos los campos', 'error');
        return;
      }
      
      if (isLocalhost) {
        showMessage(registerMessage, 'Las operaciones de registro completas requieren un origen seguro. Por favor, prueba la compatibilidad básica con el botón "Probar compatibilidad WebAuthn"', 'error');
        return;
      }
      
      try {
        // 1. Obtener challenge del Worker
        const resp = await fetch(`${SERVER_URL}/register`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ username, displayName })
        });
        
        if (!resp.ok) {
          const errorData = await resp.json();
          throw new Error(errorData.error || 'Error al solicitar el registro');
        }
        
        const data = await resp.json();
        
        // 2. Preparar datos para WebAuthn
        const publicKeyOptions = data.publicKey;
        publicKeyOptions.challenge = base64ToArrayBuffer(publicKeyOptions.challenge);
        
        // Si user.id es una string, convertirla a ArrayBuffer
        if (typeof publicKeyOptions.user.id === 'string') {
          publicKeyOptions.user.id = base64ToArrayBuffer(publicKeyOptions.user.id);
        }
        
        // 3. Crear credencial WebAuthn
        const credential = await navigator.credentials.create({
          publicKey: publicKeyOptions
        });
        
        // 4. Enviar credencial al Worker
        const verifyResp = await fetch(`${SERVER_URL}/register/verify`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            credential: {
              id: credential.id,
              rawId: arrayBufferToBase64(credential.rawId),
              response: {
                clientDataJSON: arrayBufferToBase64(credential.response.clientDataJSON),
                attestationObject: arrayBufferToBase64(credential.response.attestationObject)
              },
              type: credential.type,
              username
            }
          })
        });
        
        if (!verifyResp.ok) {
          const errorData = await verifyResp.json();
          throw new Error(errorData.error || 'Error al verificar el registro');
        }
        
        showMessage(registerMessage, "Registro exitoso. Ahora puedes iniciar sesión.", 'success');
        usernameInput.value = '';
        displaynameInput.value = '';
        
      } catch (error) {
        console.error(error);
        showMessage(registerMessage, `Error: ${error.message}`, 'error');
      }
    }

    // Event Listeners
    testButton.addEventListener("click", testWebAuthnCompat);
    registerBtn.addEventListener("click", registerWebAuthn);
    loginBtn.addEventListener("click", () => {
      if (isLocalhost) {
        showMessage(loginMessage, 'Las operaciones de login completas requieren un origen seguro. Por favor, prueba la compatibilidad básica con el botón "Probar compatibilidad WebAuthn"', 'error');
      } else {
        // Implementar login real cuando no es localhost
        alert('Función de login no implementada para esta demo.');
      }
    });
    logoutBtn.addEventListener("click", () => {
      localStorage.removeItem('webauthn_user');
      userPanel.classList.add('hidden');
    });
  </script>
</body>
</html>
